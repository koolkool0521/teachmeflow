<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆë“± 6í•™ë…„ ê³¼í•™ - ë‹¥í„° ì‚¬ì´ì–¸ìŠ¤ì˜ ìˆ˜ìˆ ì‹¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #0f172a; color: white; }
        .font-display { font-family: 'Do Hyeon', sans-serif; }
        .font-title { font-family: 'Black Han Sans', sans-serif; }
        
        /* ì‹¬ë°•ìˆ˜ ëª¨ë‹ˆí„° ì• ë‹ˆë©”ì´ì…˜ */
        .heart-rate-line {
            fill: none;
            stroke: #22c55e;
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 2s linear infinite;
        }
        .heart-rate-line.danger { stroke: #ef4444; animation-duration: 0.5s; }
        .heart-rate-line.flat { stroke: #ef4444; stroke-dasharray: 0; animation: none; }
        
        @keyframes dash {
            to { stroke-dashoffset: 0; }
        }

        /* ìˆ˜ìˆ  ë„êµ¬ ìŠ¤íƒ€ì¼ */
        .tool-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tool-btn:hover { 
            transform: translateY(-4px); 
            background-color: #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tool-btn.selected { 
            border-color: #3b82f6; 
            background-color: #1e3a8a; 
            box-shadow: 0 0 0 2px #3b82f6;
            transform: translateY(-2px);
        }

        /* ì¥ê¸°(Organs) ìŠ¤íƒ€ì¼ */
        .organ { 
            transition: all 0.3s ease; 
            cursor: pointer; 
            pointer-events: all;
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }
        .organ:hover { 
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)); 
            stroke: #fff;
            stroke-width: 3px;
        }
        
        /* í´ë¦­ ì˜ì—­ í™•ì¥ìš© íˆ¬ëª… í´ë˜ìŠ¤ */
        .hit-area {
            fill: transparent;
            stroke: transparent;
            stroke-width: 40px; /* í´ë¦­ ë²”ìœ„ ëŒ€í­ í™•ëŒ€ */
            cursor: pointer;
            pointer-events: all;
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-bg { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        
        /* í„ìŠ¤ (í´ë¦­ ìœ ë„) */
        .pulse-target { animation: target-pulse 1.5s infinite; }
        @keyframes target-pulse {
            0% { filter: drop-shadow(0 0 0 rgba(239, 68, 68, 0.7)); }
            50% { filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0)); }
            100% { filter: drop-shadow(0 0 0 rgba(239, 68, 68, 0.7)); }
        }

        /* ìˆ˜ìˆ ëŒ€ ì¡°ëª… íš¨ê³¼ */
        .spotlight {
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.1) 0%, rgba(15, 23, 42, 0) 70%);
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* ë¯¸ë‹ˆ ì‹œë®¬ë ˆì´í„° ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes sim-beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        @keyframes sim-chew { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(10px); } }
        @keyframes sim-breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes sim-move-down { 0% { transform: translateY(0); } 50% { transform: translateY(20px); } 100% { transform: translateY(0); } }
        @keyframes sim-contract { 0%, 100% { stroke-width: 10; } 50% { stroke-width: 18; } }
        @keyframes sim-signal { 0% { offset-distance: 0%; opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
        @keyframes flow { 0% { stroke-dashoffset: 20; } 100% { stroke-dashoffset: 0; } }
        @keyframes drip { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(20px); opacity: 0; } }
        
        .sim-label { font-size: 10px; font-weight: bold; fill: #94a3b8; }
        .sim-label-active { fill: #facc15; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden select-none text-slate-100">

    <!-- ìƒë‹¨: ìƒíƒœë°” -->
    <header class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center h-16 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer" onclick="resetGame()">
                <div class="bg-blue-600 p-1.5 rounded text-white font-bold">Dr.</div>
                <h1 class="text-xl font-display text-blue-400">ì‚¬ì´ì–¸ìŠ¤</h1>
            </div>
            <div class="hidden md:flex items-center gap-3">
                <span class="bg-slate-800 rounded-full px-4 py-1 text-sm text-slate-400 border border-slate-700" id="case-name">ìˆ˜ìˆ  ëŒ€ê¸°ì‹¤</span>
                <button onclick="toggleReferenceBook()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 transition shadow-lg border border-indigo-500">
                    <i data-lucide="book-open" class="w-3 h-3"></i> ì˜í•™ ë„ê°
                </button>
            </div>
        </div>

        <!-- ë°”ì´íƒˆ ëª¨ë‹ˆí„° -->
        <div class="flex items-center gap-4 flex-1 justify-end max-w-lg">
            <div class="flex flex-col items-end mr-2">
                <span class="text-[10px] text-slate-500 tracking-wider">PATIENT STATUS</span>
                <span id="patient-status-text" class="text-green-500 font-bold text-sm">STABLE</span>
            </div>
            <div class="bg-black border border-slate-700 w-48 h-10 rounded relative overflow-hidden flex items-center shadow-inner">
                <div class="absolute inset-0 bg-[linear-gradient(90deg,transparent_0%,rgba(34,197,94,0.1)_50%,transparent_100%)] animate-pulse"></div>
                <svg viewBox="0 0 200 40" class="w-full h-full relative z-10">
                    <path id="ecg-line" d="M0,20 L20,20 L30,10 L40,30 L50,10 L60,30 L70,20 L200,20" class="heart-rate-line" />
                </svg>
            </div>
            <div class="text-center w-12">
                <div class="text-[10px] text-slate-500">BPM</div>
                <div id="bpm-display" class="text-2xl font-mono text-green-500">80</div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- ì™¼ìª½: ê°„í˜¸ì‚¬/ë©”ì‹œì§€ íŒ¨ë„ -->
        <aside class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col p-4 shadow-xl z-10 relative">
            <div class="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4">
                <div class="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center overflow-hidden border-2 border-slate-600 shadow-lg shrink-0">
                    <i data-lucide="user" class="text-white w-8 h-8"></i>
                </div>
                <div>
                    <div class="text-xs text-indigo-300 font-bold uppercase tracking-wider">Head Nurse</div>
                    <div class="text-lg font-display text-white">ë‚˜ì´íŒ…ê²Œì¼</div>
                </div>
            </div>
            
            <!-- ëŒ€í™”ì°½ -->
            <div id="dialog-box" class="flex-1 bg-slate-900/50 rounded-lg p-4 mb-4 overflow-y-auto font-light text-slate-200 text-sm leading-relaxed border border-slate-700 shadow-inner">
                <p class="mb-2 text-yellow-300">"ë°•ì‚¬ë‹˜, í™˜ìë“¤ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì§‘ë„í•  ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."</p>
            </div>

            <!-- íŒíŠ¸/ëª©í‘œ -->
            <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg shrink-0">
                <h3 class="text-blue-400 text-xs font-bold mb-2 flex items-center gap-1 uppercase tracking-wider">
                    <i data-lucide="crosshair" class="w-3 h-3"></i> Current Objective
                </h3>
                <p id="current-objective" class="text-sm text-blue-100 font-bold leading-snug">í™˜ì ì¼€ì´ìŠ¤ ì„ íƒí•˜ê¸°</p>
            </div>
        </aside>

        <!-- ì¤‘ì•™: ìˆ˜ìˆ ëŒ€ (ì‹œê°í™” ì˜ì—­) -->
        <main class="flex-1 bg-slate-950 relative flex flex-col">
            
            <!-- ì¡°ëª… íš¨ê³¼ -->
            <div class="absolute inset-0 spotlight pointer-events-none"></div>

            <!-- ìˆ˜ìˆ  í™”ë©´ (SVG) -->
            <div id="surgery-stage" class="flex-1 flex items-center justify-center relative z-0 p-4 overflow-hidden">
                <!-- ì—¬ê¸°ì— ê²Œì„ ì½˜í…ì¸ (SVG)ê°€ ë Œë”ë§ë¨ -->
            </div>

            <!-- í•˜ë‹¨: ë„êµ¬ ëª¨ìŒ (Toolbox) -->
            <div id="toolbox" class="h-28 bg-slate-800 border-t border-slate-700 p-3 flex justify-center items-center gap-4 shrink-0 z-10 hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
                <!-- ë„êµ¬ ë²„íŠ¼ë“¤ì´ JSë¡œ ìƒì„±ë¨ -->
            </div>
        </main>
    </div>

    <!-- ì˜¤ë²„ë ˆì´: ì˜í•™ ë„ê° -->
    <div id="reference-book" class="hidden absolute inset-0 modal-bg z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl border border-slate-600 flex flex-col overflow-hidden relative">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900">
                <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                    <i data-lucide="book" class="w-6 h-6"></i> ìš°ë¦¬ ëª¸ ì˜í•™ ë„ê° & ì‹œë®¬ë ˆì´í„°
                </h2>
                <button onclick="toggleReferenceBook()" class="text-slate-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- ì‚¬ì´ë“œë°” -->
                <div class="w-48 bg-slate-800 border-r border-slate-700 p-2 overflow-y-auto">
                    <button onclick="showRefCategory('digestive')" class="w-full text-left p-3 rounded hover:bg-slate-700 text-sm font-bold text-slate-300 transition">ì†Œí™” ê¸°ê´€</button>
                    <button onclick="showRefCategory('respiratory')" class="w-full text-left p-3 rounded hover:bg-slate-700 text-sm font-bold text-slate-300 transition">í˜¸í¡ ê¸°ê´€</button>
                    <button onclick="showRefCategory('circulatory')" class="w-full text-left p-3 rounded hover:bg-slate-700 text-sm font-bold text-slate-300 transition">ìˆœí™˜ ê¸°ê´€</button>
                    <button onclick="showRefCategory('sensory')" class="w-full text-left p-3 rounded hover:bg-slate-700 text-sm font-bold text-slate-300 transition">ê°ê°/ì‹ ê²½ê³„</button>
                    <button onclick="showRefCategory('muscular')" class="w-full text-left p-3 rounded hover:bg-slate-700 text-sm font-bold text-slate-300 transition">ìš´ë™ ê¸°ê´€</button>
                </div>
                <!-- ë‚´ìš© -->
                <div id="ref-content" class="flex-1 p-6 overflow-y-auto bg-slate-900/50 scrollbar-hide">
                    <p class="text-slate-400 text-center mt-20">ì¢Œì¸¡ ë©”ë‰´ì—ì„œ ê¶ê¸ˆí•œ ê¸°ê´€ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Select Screen -->
    <div id="case-select-screen" class="absolute inset-0 bg-slate-900/95 z-40 flex items-center justify-center backdrop-blur-md">
        <div class="max-w-6xl w-full p-8 h-full overflow-y-auto">
            <div class="text-center mb-10 pt-10">
                <div class="inline-block bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full mb-3">MEDICAL SIMULATION</div>
                <h2 class="text-5xl font-title text-white mb-2"><span class="text-blue-500">ë‹¥í„° ì‚¬ì´ì–¸ìŠ¤</span>ì˜ ìˆ˜ìˆ ì‹¤</h2>
                <p class="text-slate-400">ì˜¤ëŠ˜ ì§‘ë„í•  í™˜ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”. ì •í™•í•œ ì˜í•™ ì§€ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <button onclick="toggleReferenceBook()" class="mt-4 text-indigo-400 hover:text-indigo-300 underline text-sm">
                    ìˆ˜ìˆ  ì „ ì˜í•™ ë„ê° í™•ì¸í•˜ê¸°
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 pb-10">
                <button onclick="startGame('digestive')" class="group bg-slate-800 border border-slate-700 hover:border-yellow-500 hover:bg-slate-750 p-5 rounded-2xl transition-all duration-300 text-left hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-yellow-500/10 p-2 rounded-xl text-yellow-500 group-hover:bg-yellow-500 group-hover:text-white transition-colors">
                            <i data-lucide="utensils" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-slate-500 uppercase">ì†Œí™”ê¸°ê´€</span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-yellow-400 transition-colors">í­ì‹ í™˜ì ê¹€ë¨¹ë³´</h3>
                    <p class="text-xs text-slate-400 leading-relaxed">"ë°°ê°€ ë„ˆë¬´ ì•„íŒŒìš”..." <br>ì†Œí™” ë¶ˆëŸ‰ ë° ìœ„ì¥ ì¥ì• </p>
                </button>
                <button onclick="startGame('respiratory')" class="group bg-slate-800 border border-slate-700 hover:border-sky-500 hover:bg-slate-750 p-5 rounded-2xl transition-all duration-300 text-left hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-sky-500/10 p-2 rounded-xl text-sky-500 group-hover:bg-sky-500 group-hover:text-white transition-colors">
                            <i data-lucide="wind" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-slate-500 uppercase">í˜¸í¡ê¸°ê´€</span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-sky-400 transition-colors">ìˆ¨ì°¬ ë‹¤ì´ë²„ ë°•í•´ë…€</h3>
                    <p class="text-xs text-slate-400 leading-relaxed">"ìˆ¨ì´ ì•ˆ ì‰¬ì–´ì ¸ìš”..." <br>ê°€ë¡œë§‰ ê²½ë ¨ ë° í˜¸í¡ ê³¤ë€</p>
                </button>
                <button onclick="startGame('circulatory')" class="group bg-slate-800 border border-slate-700 hover:border-red-500 hover:bg-slate-750 p-5 rounded-2xl transition-all duration-300 text-left hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-red-500/10 p-2 rounded-xl text-red-500 group-hover:bg-red-500 group-hover:text-white transition-colors">
                            <i data-lucide="heart-pulse" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-slate-500 uppercase">ìˆœí™˜ê¸°ê´€</span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-red-400 transition-colors">ì‹¬ì¥ ë©ˆì¶˜ ì´íšŒì¥</h3>
                    <p class="text-xs text-slate-400 leading-relaxed">"ê°€ìŠ´ì´ ê½‰ ë§‰í˜€!" <br>ì‹¬ì¥ íŒí”„ ê¸°ëŠ¥ ì •ì§€</p>
                </button>
                <button onclick="startGame('sensory')" class="group bg-slate-800 border border-slate-700 hover:border-pink-500 hover:bg-slate-750 p-5 rounded-2xl transition-all duration-300 text-left hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-pink-500/10 p-2 rounded-xl text-pink-500 group-hover:bg-pink-500 group-hover:text-white transition-colors">
                            <i data-lucide="eye" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-slate-500 uppercase">ê°ê°ê¸°ê´€</span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-pink-400 transition-colors">ì–´ì§€ëŸ¬ìš´ ë‚˜ê³µë¶€</h3>
                    <p class="text-xs text-slate-400 leading-relaxed">"ì–´ì§€ëŸ¬ì›Œìš”..." <br>ì‹ ê²½ ì „ë‹¬ ì¥ì• </p>
                </button>
                <button onclick="startGame('muscular')" class="group bg-slate-800 border border-slate-700 hover:border-purple-500 hover:bg-slate-750 p-5 rounded-2xl transition-all duration-300 text-left hover:-translate-y-1 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-purple-500/10 p-2 rounded-xl text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                            <i data-lucide="dumbbell" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-slate-500 uppercase">ìš´ë™ê¸°ê´€</span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-purple-400 transition-colors">íŒ” ë¶€ëŸ¬ì§„ ìµœì„ ìˆ˜</h3>
                    <p class="text-xs text-slate-400 leading-relaxed">"íŒ”ì´ ì•ˆ ì›€ì§ì—¬ìš”!" <br>ê³¨ì ˆ ë° ê·¼ìœ¡ íŒŒì—´</p>
                </button>
            </div>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ë“¤ -->
    <div id="bad-ending-screen" class="hidden absolute inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="newspaper max-w-2xl w-full p-8 shadow-2xl relative animate-[fadeIn_0.5s_ease-out]">
            <div class="border-b-4 border-black mb-6 pb-2 flex justify-between items-end">
                <h2 class="text-5xl font-title text-red-700 tracking-tighter">ë‰´ìŠ¤ íŠ¹ë³´</h2>
            </div>
            <div class="flex gap-8">
                <div class="flex-1">
                    <h3 class="text-3xl font-display font-bold mb-6 leading-tight text-slate-900">"ë‹¥í„° ì‚¬ì´ì–¸ìŠ¤,<br>ì¶©ê²©ì˜ ì˜ë£Œ ê³¼ì‹¤"</h3>
                    <p class="text-justify font-serif text-lg leading-relaxed mb-4 text-slate-800">
                        ìˆ˜ìˆ  ê³¼ì •ì„ ì§€ì¼œë³´ë˜ ê°€ì¡±ë“¤ì€ <span class="font-bold bg-yellow-200 px-1">"ê¸°ë³¸ì ì¸ ì˜í•™ ì§€ì‹ì´ ë¶€ì¡±í•˜ë‹¤"</span>ë©° ë¶„í†µì„ í„°ëœ¨ë ¸ë‹¤.
                    </p>
                </div>
                <div class="w-48 flex flex-col gap-2">
                    <div class="w-full h-48 bg-slate-200 flex items-center justify-center border-2 border-black overflow-hidden relative">
                         <i data-lucide="frown" class="w-20 h-20 text-slate-600 relative z-10"></i>
                    </div>
                </div>
            </div>
            <button onclick="resetGame()" class="absolute -bottom-16 left-1/2 -translate-x-1/2 bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg transition text-lg flex items-center gap-2 hover:scale-105">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i> ì¬ë„ì „
            </button>
        </div>
    </div>

    <div id="happy-ending-screen" class="hidden absolute inset-0 bg-green-900/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-xl w-full p-10 rounded-sm shadow-2xl transform rotate-1 relative paper-texture text-slate-800 animate-[fadeIn_0.5s_ease-out]">
            <div class="absolute -top-4 -right-4 bg-red-600 text-white w-20 h-20 rounded-full flex items-center justify-center font-bold shadow-lg rotate-12 border-4 border-white opacity-90 text-center leading-tight">ìˆ˜ìˆ <br>ì„±ê³µ</div>
            <h2 class="text-3xl font-serif font-bold mb-8 text-center border-b-2 border-slate-100 pb-4 text-slate-700">ê°ì‚¬ì˜ í¸ì§€</h2>
            <div class="font-serif text-lg leading-relaxed mb-10 space-y-4 text-slate-600 px-4">
                <p>ì„ ìƒë‹˜ì˜ ì™„ë²½í•œ ìˆ˜ìˆ  ë•ë¶„ì— ì œ ëª¸ì´ ë‹¤ì‹œ ê±´ê°•í•´ì¡ŒìŠµë‹ˆë‹¤!</p>
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500 my-4">
                    <p class="text-green-800 font-bold mb-1">ğŸ’¡ ì²˜ë°©:</p>
                    <p id="success-reason" class="text-green-700 text-base">--ì„±ê³µ ìš”ì¸--</p>
                </div>
            </div>
            <div class="text-center">
                <button onclick="resetGame()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-full font-bold shadow-xl transition text-lg flex items-center gap-2 mx-auto hover:scale-105">
                    ë‹¤ìŒ í™˜ì ë°›ê¸° <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const TOOL_ICONS = {
            'stethoscope': 'stethoscope', 'scanner': 'scan', 'microscope': 'microscope', 
            'scalpel': 'knife', 'forceps': 'scissors', 'enzyme': 'flask-conical', 'suture': 'syringe',
            'oxygen': 'wind', 'relaxant': 'droplet', 'hand': 'hand', 'nutrient': 'pill',
            'defib': 'zap', 'connector': 'link', 'light': 'lightbulb', 'drops': 'droplets', 'drill': 'hammer'
        };

        const organReference = {
            // ... (Previous data)
            digestive: [
                { id: 'mouth', name: "ì… (Mouth)", role: "ì´ë¡œ ìŒì‹ë¬¼ì„ ì˜ê²Œ ë¶€ìˆ˜ê³ (ì €ì‘), ì¹¨ê³¼ ì„ì–´ ë¶€ë“œëŸ½ê²Œ ë§Œë“­ë‹ˆë‹¤.", sim: "chew" },
                { id: 'esophagus', name: "ì‹ë„ (Esophagus)", role: "ìŒì‹ë¬¼ì´ ìœ„ë¡œ ì´ë™í•˜ëŠ” í†µë¡œì…ë‹ˆë‹¤. ê·¼ìœ¡ì˜ ê¿ˆí‹€ ìš´ë™ìœ¼ë¡œ ìŒì‹ë¬¼ì„ ë‚´ë ¤ë³´ëƒ…ë‹ˆë‹¤.", sim: "move-down" },
                { id: 'stomach', name: "ìœ„ (Stomach)", role: "ì£¼ë¨¸ë‹ˆ ëª¨ì–‘ì˜ ê·¼ìœ¡ì§ˆ ì¥ê¸°ì…ë‹ˆë‹¤. ìœ„ì•¡ì„ ì„ì–´ ìŒì‹ë¬¼ì„ ì£½ì²˜ëŸ¼ ë¶„í•´(ì†Œí™”)í•©ë‹ˆë‹¤.", sim: "churn" },
                { id: 'small_intestine', name: "ì‘ì€ì°½ì (Small Intestine)", role: "ì†Œí™” ê¸°ê´€ ì¤‘ ê°€ì¥ ê¹ë‹ˆë‹¤. ìŒì‹ë¬¼ì˜ ì˜ì–‘ì†Œë¥¼ í¡ìˆ˜í•©ë‹ˆë‹¤.", sim: "absorb" },
                { id: 'large_intestine', name: "í°ì°½ì (Large Intestine)", role: "ì†Œí™”ë˜ê³  ë‚¨ì€ ì°Œêº¼ê¸°ì—ì„œ ë¬¼ì„ í¡ìˆ˜í•˜ê³  ëŒ€ë³€ì„ ë§Œë“­ë‹ˆë‹¤.", sim: "absorb-water" },
                { id: 'liver', name: "ê°„ (Liver)", role: "ì“¸ê°œì¦™ì„ ë§Œë“¤ì–´ ì§€ë°© ì†Œí™”ë¥¼ ë•ê³ , í•´ë… ì‘ìš©ì„ í•©ë‹ˆë‹¤.", sim: "bile-secretion" },
                { id: 'gallbladder', name: "ì“¸ê°œ (Gallbladder)", role: "ê°„ì—ì„œ ë§Œë“  ì“¸ê°œì¦™ì„ ì €ì¥í–ˆë‹¤ê°€ ë¶„ë¹„í•˜ì—¬ ì§€ë°© ì†Œí™”ë¥¼ ë•ìŠµë‹ˆë‹¤.", sim: "bile-secretion" },
                { id: 'pancreas', name: "ì´ì (Pancreas)", role: "ì´ìì•¡(ì†Œí™” íš¨ì†Œ)ì„ ë§Œë“¤ì–´ ì†Œì¥ìœ¼ë¡œ ë¶„ë¹„í•˜ì—¬ íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©ì„ ëª¨ë‘ ì†Œí™”ì‹œí‚µë‹ˆë‹¤.", sim: "pancreas-juice" }
            ],
            respiratory: [
                { id: 'trachea', name: "ê¸°ê´€/ê¸°ê´€ì§€", role: "ê³µê¸°ê°€ íë¡œ ì´ë™í•˜ëŠ” í†µë¡œì…ë‹ˆë‹¤.", sim: "airflow" },
                { id: 'lungs', name: "í (Lung)", role: "ëª¸ì†ì˜ ì´ì‚°í™”íƒ„ì†Œë¥¼ ë‚´ë³´ë‚´ê³  ì‚°ì†Œë¥¼ ë°›ì•„ë“¤ì´ëŠ” ê°€ìŠ¤ êµí™˜ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.", sim: "breathe" },
                { id: 'diaphragm', name: "ê°€ë¡œë§‰", role: "í ì•„ë˜ì— ìˆëŠ” ê·¼ìœ¡íŒì…ë‹ˆë‹¤. í˜¸í¡ ìš´ë™ì„ ë•ìŠµë‹ˆë‹¤.", sim: "move-updown" }
            ],
            circulatory: [
                { id: 'heart', name: "ì‹¬ì¥ (Heart)", role: "íŒí”„ ì‘ìš©ì„ í•˜ì—¬ í˜ˆì•¡ì„ ì˜¨ëª¸ìœ¼ë¡œ ìˆœí™˜ì‹œí‚µë‹ˆë‹¤.", sim: "beat" },
                { id: 'artery', name: "ë™ë§¥ (Artery)", role: "ì‹¬ì¥ì—ì„œ ë‚˜ê°€ëŠ” í˜ˆì•¡ì´ íë¥´ëŠ” í˜ˆê´€ì…ë‹ˆë‹¤. ë²½ì´ ë‘ê»ê³  íƒ„ë ¥ì´ ìˆìŠµë‹ˆë‹¤.", sim: "flow-fast" },
                { id: 'vein', name: "ì •ë§¥ (Vein)", role: "ì˜¨ëª¸ì„ ëŒê³  ì‹¬ì¥ìœ¼ë¡œ ëŒì•„ì˜¤ëŠ” í˜ˆì•¡ì´ íë¥´ëŠ” í˜ˆê´€ì…ë‹ˆë‹¤.", sim: "flow-slow" }
            ],
            sensory: [
                { id: 'nerve', name: "ì‹ ê²½ê³„ (Nervous System)", role: "ê°ê° ê¸°ê´€ì—ì„œ ë°›ì€ ìê·¹ì„ ë‡Œë¡œ ì „ë‹¬í•˜ê³ , ë‡Œì˜ ëª…ë ¹ì„ ìš´ë™ ê¸°ê´€ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.", sim: "transmit" },
                { id: 'brain', name: "ë‡Œ (Brain)", role: "ìê·¹ì„ í•´ì„í•˜ê³  íŒë‹¨í•˜ì—¬ ì ì ˆí•œ ë°˜ì‘ì„ ëª…ë ¹í•©ë‹ˆë‹¤.", sim: "think" }
            ],
            muscular: [
                { id: 'bone', name: "ë¼ˆ (Bone)", role: "ëª¸ì˜ í˜•íƒœë¥¼ ìœ ì§€í•˜ê³  ë‚´ë¶€ ê¸°ê´€ì„ ë³´í˜¸í•©ë‹ˆë‹¤. ê·¼ìœ¡ê³¼ ì—°ê²°ë˜ì–´ ëª¸ì„ ì§€íƒ±í•©ë‹ˆë‹¤.", sim: "bone-support" },
                { id: 'muscle', name: "ê·¼ìœ¡ (Muscle)", role: "ê¸¸ì´ê°€ ì¤„ì–´ë“¤ê±°ë‚˜(ìˆ˜ì¶•) ëŠ˜ì–´ë‚˜ë©´ì„œ(ì´ì™„) ë¼ˆë¥¼ ë‹¹ê²¨ ëª¸ì„ ì›€ì§ì´ê²Œ í•©ë‹ˆë‹¤.", sim: "contract" }
            ]
        };

        const cases = {
            digestive: {
                name: "í­ì‹ í™˜ì ê¹€ë¨¹ë³´",
                symptoms: "ì „ì²´ ì†Œí™” ë¶ˆëŸ‰",
                dialogues: ["ì…ë¶€í„° ëŒ€ì¥ê¹Œì§€ ëª¨ë“  ì†Œí™” ê³¼ì •ì— ë¬¸ì œê°€ ìƒê¸´ ê²ƒ ê°™ìŠµë‹ˆë‹¤."],
                tools: [{id:'stethoscope',name:'ì²­ì§„ê¸°',desc:'í™•ì¸'},{id:'scalpel',name:'ë©”ìŠ¤',desc:'ì ˆê°œ'},{id:'forceps',name:'ê²¸ì',desc:'ì œê±°'},{id:'enzyme',name:'ì†Œí™”íš¨ì†Œ',desc:'ë¶„í•´'},{id:'nutrient',name:'ì˜ì–‘ì œ',desc:'í¡ìˆ˜'},{id:'suture',name:'ë´‰í•©ì‚¬',desc:'ë´‰í•©'}],
                steps: [
                    {msg:"'ì²­ì§„ê¸°'ë¡œ ë³µë¶€ë¥¼ ì§„ì°°í•˜ì„¸ìš”.",action:"use_tool",tool:"stethoscope",target:"stomach",hint:"ìœ„ì¥ ì†Œë¦¬ í™•ì¸.",postMsg:"ì¥ ìš´ë™ ì •ì§€ í™•ì¸."},
                    {msg:"'ì…'ì„ ê²€ì‚¬í•˜ì„¸ìš”.",action:"click_organ",target:"head",hint:"ì €ì‘ ìš´ë™ í™•ì¸.",postMsg:"ì¹˜ì•„ ìƒíƒœ ì–‘í˜¸."},
                    {msg:"'ê²¸ì'ë¡œ ì‹ë„ë¥¼ ëš«ì–´ì£¼ì„¸ìš”.",action:"use_tool",tool:"forceps",target:"esophagus",hint:"ëª© ë¶€ë¶„.",postMsg:"ì‹ë„ í™•ë³´."},
                    {msg:"'ìœ„'ë¥¼ í´ë¦­í•˜ì„¸ìš”.",action:"click_organ",target:"stomach",hint:"ì™¼ìª½ ê°ˆë¹„ë¼ˆ ì•„ë˜.",postMsg:"ìœ„ íŒ½ì°½ í™•ì¸."},
                    {msg:"'ë©”ìŠ¤'ë¡œ ìœ„ë¥¼ ì ˆê°œí•˜ì„¸ìš”.",action:"use_tool",tool:"scalpel",target:"stomach",hint:"ë‚´ë¶€ í™•ì¸.",postMsg:"ì ˆê°œ ì™„ë£Œ."},
                    {msg:"'ê²¸ì'ë¡œ ìŒì‹ë¬¼ ë©ì–´ë¦¬ë¥¼ ì œê±°í•˜ì„¸ìš”.",action:"use_tool",tool:"forceps",target:"food-lump",hint:"ì´ë¬¼ì§ˆ ì œê±°.",postMsg:"ì´ë¬¼ì§ˆ ì œê±°ë¨."},
                    {msg:"'ì†Œí™”íš¨ì†Œ'ë¥¼ ë¿Œë ¤ì£¼ì„¸ìš”.",action:"use_tool",tool:"enzyme",target:"stomach-inner",hint:"ë¶„í•´ ì‹œì‘ (ìœ„ ì „ì²´ í´ë¦­ ê°€ëŠ¥).",postMsg:"ìŒì‹ë¬¼ ë¶„í•´ ì¤‘."},
                    {msg:"'ì˜ì–‘ì œ'ë¥¼ ì†Œì¥ì— íˆ¬ì—¬í•˜ì„¸ìš”.",action:"use_tool",tool:"nutrient",target:"small-intestine",hint:"í¡ìˆ˜ ê¸°ëŠ¥.",postMsg:"ì˜ì–‘ì†Œ í¡ìˆ˜ ì¬ê°œ."},
                    {msg:"ëŒ€ì¥ì„ ë§ˆì‚¬ì§€í•˜ì„¸ìš”.",action:"click_organ",target:"large-intestine",hint:"ìˆ˜ë¶„ í¡ìˆ˜.",postMsg:"ì†Œí™” ê³¼ì • ì •ìƒí™”."}
                ],
                successMsg: "ì†Œí™”ì™€ í¡ìˆ˜ ê³¼ì •ì„ ì •ìƒí™”í–ˆìŠµë‹ˆë‹¤."
            },
            respiratory: {
                name: "ìˆ¨ì°¬ ë‹¤ì´ë²„ ë°•í•´ë…€",
                symptoms: "ì‹¬ê°í•œ í˜¸í¡ ê³¤ë€",
                dialogues: ["í˜¸í¡ ê³¤ë€ í™˜ìì…ë‹ˆë‹¤."],
                tools: [{id:'oxygen',name:'ì‚°ì†Œ ë§ˆìŠ¤í¬',desc:'ì‚°ì†Œ'},{id:'forceps',name:'ê²¸ì',desc:'ì´ë¬¼ì§ˆ'},{id:'relaxant',name:'ì´ì™„ì œ',desc:'ê·¼ìœ¡'},{id:'hand',name:'ì†',desc:'ë§ˆì‚¬ì§€'}],
                steps: [
                    {msg:"'ê²¸ì'ë¡œ ê¸°ë„ë¥¼ í™•ë³´í•˜ì„¸ìš”.",action:"use_tool",tool:"forceps",target:"head",hint:"ì… ì•ˆ.",postMsg:"ê¸°ë„ í™•ë³´."},
                    {msg:"'ê¸°ê´€ì§€'ë¥¼ í™•ì¸í•˜ì„¸ìš”.",action:"click_organ",target:"bronchi",hint:"íë¡œ ê°€ëŠ” ê¸¸.",postMsg:"í†µë¡œ ì •ìƒ."},
                    {msg:"'ì‚°ì†Œ ë§ˆìŠ¤í¬'ë¥¼ ì”Œìš°ì„¸ìš”.",action:"use_tool",tool:"oxygen",target:"head",hint:"ì‚°ì†Œ ê³µê¸‰.",postMsg:"ì‚°ì†Œ ê³µê¸‰ ì¤‘."},
                    {msg:"'ê°€ë¡œë§‰'ì„ ì°¾ìœ¼ì„¸ìš”.",action:"click_organ",target:"diaphragm",hint:"í ì•„ë˜.",postMsg:"ê²½ì§ í™•ì¸."},
                    {msg:"'ì´ì™„ì œ'ë¥¼ ì£¼ì‚¬í•˜ì„¸ìš”.",action:"use_tool",tool:"relaxant",target:"diaphragm",hint:"ê·¼ìœ¡ ì´ì™„.",postMsg:"ê°€ë¡œë§‰ ì´ì™„ë¨."},
                    {msg:"'ì†'ìœ¼ë¡œ ê°€ë¡œë§‰ì„ ë‹¹ê¸°ì„¸ìš”.",action:"use_tool",tool:"hand",target:"diaphragm",hint:"í˜¸í¡ ìœ ë„.",postMsg:"ìê°€ í˜¸í¡ íšŒë³µ!"}
                ],
                successMsg: "ê¸°ë„ í™•ë³´ ë° í˜¸í¡ ìš´ë™ ì •ìƒí™”."
            },
            circulatory: {
                name: "ì‹¬ì¥ ë©ˆì¶˜ ì´íšŒì¥",
                symptoms: "ì‹¬ì •ì§€",
                dialogues: ["ì‹¬ì •ì§€ í™˜ìì…ë‹ˆë‹¤."],
                tools: [{id:'stethoscope',name:'ì²­ì§„ê¸°',desc:'ì§„ì°°'},{id:'defib',name:'ì œì„¸ë™ê¸°',desc:'ì¶©ê²©'},{id:'connector',name:'í˜ˆê´€ íŠœë¸Œ',desc:'ì—°ê²°'},{id:'scanner',name:'ìŠ¤ìºë„ˆ',desc:'í™•ì¸'}],
                steps: [
                    {msg:"'ì²­ì§„ê¸°'ë¡œ ì‹¬ì¥ì„ í™•ì¸í•˜ì„¸ìš”.",action:"use_tool",tool:"stethoscope",target:"heart",hint:"ê°€ìŠ´ ì¤‘ì•™.",postMsg:"ì‹¬ë°• ì •ì§€."},
                    {msg:"'ì œì„¸ë™ê¸°'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.",action:"use_tool",tool:"defib",target:"heart",hint:"ì „ê¸° ì¶©ê²©.",postMsg:"ì‹¬ë°• ì¬ê°œ."},
                    {msg:"'í˜ˆê´€ íŠœë¸Œ'ë¡œ ë™ë§¥ì„ ì—°ê²°í•˜ì„¸ìš”.",action:"use_tool",tool:"connector",target:"aorta",hint:"ë‚˜ê°€ëŠ” í˜ˆê´€.",postMsg:"ë™ë§¥ ì—°ê²°."},
                    {msg:"ì •ë§¥ì„ í™•ì¸í•˜ì„¸ìš”.",action:"click_organ",target:"veins",hint:"ëŒì•„ì˜¤ëŠ” í˜ˆê´€.",postMsg:"ì •ë§¥ í™•ì¸."},
                    {msg:"'ìŠ¤ìºë„ˆ'ë¡œ ì „ì‹ ì„ í™•ì¸í•˜ì„¸ìš”.",action:"use_tool",tool:"scanner",target:"body-bg",hint:"ì „ì‹  ìˆœí™˜.",postMsg:"ìˆœí™˜ ì •ìƒ."}
                ],
                successMsg: "í˜ˆì•¡ ìˆœí™˜ ì‹œìŠ¤í…œ ë³µêµ¬."
            },
            sensory: {
                name: "ì–´ì§€ëŸ¬ìš´ ë‚˜ê³µë¶€",
                symptoms: "ê°ê° ì´ìƒ",
                dialogues: ["ì‹ ê²½ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”."],
                tools: [{id:'light',name:'ë¶ˆë¹›',desc:'ìê·¹'},{id:'microscope',name:'í˜„ë¯¸ê²½',desc:'ê´€ì°°'},{id:'connector',name:'ì‹ ê²½ íŠœë¸Œ',desc:'ì—°ê²°'},{id:'scanner',name:'ìŠ¤ìºë„ˆ',desc:'ë‡Œ'}],
                steps: [
                    {msg:"'ë¶ˆë¹›'ìœ¼ë¡œ ëˆˆì„ ê²€ì‚¬í•˜ì„¸ìš”.",action:"use_tool",tool:"light",target:"eye-left",hint:"ë™ê³µ ë°˜ì‘.",postMsg:"ë°˜ì‘ ì—†ìŒ."},
                    {msg:"'í˜„ë¯¸ê²½'ìœ¼ë¡œ ì‹œì‹ ê²½ì„ ë³´ì„¸ìš”.",action:"use_tool",tool:"microscope",target:"eye-left",hint:"ì†ìƒ í™•ì¸.",postMsg:"ì‹ ê²½ ëŠì–´ì§."},
                    {msg:"'ì‹ ê²½ íŠœë¸Œ'ë¡œ ì—°ê²°í•˜ì„¸ìš”.",action:"use_tool",tool:"connector",target:"brain",hint:"ë‡Œë¡œ ì—°ê²°.",postMsg:"ì‹ ê²½ ì—°ê²°ë¨."},
                    {msg:"'ìŠ¤ìºë„ˆ'ë¡œ ë‡Œë¥¼ í™•ì¸í•˜ì„¸ìš”.",action:"use_tool",tool:"scanner",target:"brain",hint:"ë‡Œ í™œë™.",postMsg:"ë‡Œ í™œì„±í™”."},
                    {msg:"ì†ì„ í´ë¦­í•´ ë°˜ì‘ì„ ë³´ì„¸ìš”.",action:"click_organ",target:"hand-area",hint:"ìš´ë™ ì‹ ê²½.",postMsg:"ë°˜ì‘ ì •ìƒ."}
                ],
                successMsg: "ì‹ ê²½ ì „ë‹¬ ê²½ë¡œ íšŒë³µ."
            },
            muscular: {
                name: "íŒ” ë¶€ëŸ¬ì§„ ìµœì„ ìˆ˜",
                symptoms: "ê³¨ì ˆ",
                dialogues: ["ê³¨ì ˆ í™˜ìì…ë‹ˆë‹¤."],
                tools: [{id:'scanner',name:'X-ray',desc:'ì´¬ì˜'},{id:'hand',name:'ì†',desc:'ì •ë³µ'},{id:'drill',name:'ë“œë¦´',desc:'ê³ ì •'},{id:'suture',name:'ë´‰í•©ì‚¬',desc:'ì—°ê²°'},{id:'relaxant',name:'ì˜ì–‘ì œ',desc:'ê°•í™”'}],
                steps: [
                    {msg:"'X-ray'ë¡œ íŒ”ì„ ì°ìœ¼ì„¸ìš”.",action:"use_tool",tool:"scanner",target:"arm-area",hint:"ë¼ˆ ìƒíƒœ.",postMsg:"ê³¨ì ˆ í™•ì¸."},
                    {msg:"'ì†'ìœ¼ë¡œ ë¼ˆë¥¼ ë§ì¶”ì„¸ìš”.",action:"use_tool",tool:"hand",target:"broken-bone",hint:"ì •ë³µ.",postMsg:"ë¼ˆ ì •ë³µ."},
                    {msg:"'ë“œë¦´'ë¡œ ê³ ì •í•˜ì„¸ìš”.",action:"use_tool",tool:"drill",target:"broken-bone",hint:"ê³ ì •.",postMsg:"í•€ ê³ ì •."},
                    {msg:"'ë´‰í•©ì‚¬'ë¡œ ê·¼ìœ¡ì„ ì´ìœ¼ì„¸ìš”.",action:"use_tool",tool:"suture",target:"biceps",hint:"ê·¼ìœ¡ ì—°ê²°.",postMsg:"ê·¼ìœ¡ ë´‰í•©."},
                    {msg:"'ì˜ì–‘ì œ'ë¥¼ íˆ¬ì—¬í•˜ì„¸ìš”.",action:"use_tool",tool:"relaxant",target:"biceps",hint:"ê¸°ëŠ¥ íšŒë³µ.",postMsg:"íŒ” ì›€ì§ì„ íšŒë³µ."}
                ],
                successMsg: "ìš´ë™ ê¸°ëŠ¥ íšŒë³µ."
            }
        };

        // --- Logic ---
        let currentCase = null, currentStepIndex = 0, selectedTool = null, mistakes = 0, patientHealth = 100;
        const els = {
            dialogBox: document.getElementById('dialog-box'), surgeryStage: document.getElementById('surgery-stage'),
            toolbox: document.getElementById('toolbox'), caseSelectScreen: document.getElementById('case-select-screen'),
            headerCaseName: document.getElementById('case-name'), patientStatusText: document.getElementById('patient-status-text'),
            bpmDisplay: document.getElementById('bpm-display'), ecgLine: document.getElementById('ecg-line'),
            currentObjective: document.getElementById('current-objective'), badEndingScreen: document.getElementById('bad-ending-screen'),
            happyEndingScreen: document.getElementById('happy-ending-screen'), successReason: document.getElementById('success-reason'),
            referenceBook: document.getElementById('reference-book'), refContent: document.getElementById('ref-content')
        };

        function startGame(caseId) {
            currentCase = cases[caseId]; currentStepIndex = 0; selectedTool = null; mistakes = 0; patientHealth = 100;
            els.caseSelectScreen.classList.add('hidden'); els.toolbox.classList.remove('hidden');
            els.headerCaseName.innerText = `ì§‘ë„ ì¤‘: ${currentCase.name}`; updateStatus();
            els.dialogBox.innerHTML = currentCase.dialogues.map(d => `<p class="mb-3">- ${d}</p>`).join('');
            renderTools(); renderSurgeryStage(caseId); nextStep();
        }
        function resetGame() {
            els.happyEndingScreen.classList.add('hidden'); els.badEndingScreen.classList.add('hidden');
            els.caseSelectScreen.classList.remove('hidden'); els.toolbox.classList.add('hidden'); els.surgeryStage.innerHTML = '';
        }
        function toggleReferenceBook() {
            els.referenceBook.classList.toggle('hidden');
            if(!els.referenceBook.classList.contains('hidden')) showRefCategory('digestive');
        }
        function showRefCategory(cat) {
            const data = organReference[cat];
            let html = `<h3 class="text-2xl font-bold mb-4 text-blue-400 border-b border-slate-600 pb-2">${cat.toUpperCase()}</h3><div class="grid gap-6 grid-cols-1 md:grid-cols-2">`;
            data.forEach(item => {
                html += `<div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-3"><strong class="text-lg text-yellow-400">${item.name}</strong></div>
                    <p class="text-slate-300 text-sm leading-relaxed mb-4 min-h-[40px]">${item.role}</p>
                    ${item.sim !== 'none' ? `<div id="sim-container-${item.id}" class="h-48 bg-slate-900 rounded-lg flex flex-col items-center justify-center border border-slate-700 relative overflow-hidden"><button onclick="runMiniSim('${item.id}', '${item.sim}')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded-full transition flex items-center gap-1"><i data-lucide="play" class="w-3 h-3"></i> ì‹œë®¬ë ˆì´í„° ì‹¤í–‰</button></div>` : ''}
                </div>`;
            });
            html += `</div>`;
            els.refContent.innerHTML = html; lucide.createIcons();
        }

        // --- Interactive Mini Simulators ---
        window.simAction = function(action) {
            if(action === 'chew') {
                const jaw = document.getElementById('sim-jaw');
                const food = document.getElementById('sim-food');
                jaw.style.animation = "sim-chew 0.5s 3";
                setTimeout(() => {
                    food.innerHTML = `<circle cx="45" cy="50" r="3" fill="#ef4444" /><circle cx="55" cy="50" r="3" fill="#ef4444" /><circle cx="50" cy="45" r="3" fill="#ef4444" />`;
                }, 500);
            } else if(action === 'churn') {
                const stomach = document.getElementById('sim-stomach-shape');
                const food = document.getElementById('sim-stomach-food');
                stomach.style.animation = "sim-contract 1s 3";
                setTimeout(() => { food.setAttribute('fill', '#facc15'); }, 1000);
            } else if(action === 'stimulate') {
                const signal = document.getElementById('sim-nerve-signal');
                const brain = document.getElementById('sim-brain');
                signal.style.animation = 'none'; void signal.offsetWidth; 
                signal.style.animation = "sim-signal 1.5s linear forwards";
                setTimeout(() => {
                    brain.setAttribute('fill', '#f472b6'); setTimeout(() => brain.setAttribute('fill', '#475569'), 500);
                }, 1500);
            } else if(action === 'muscle-contract') {
                document.getElementById('sim-arm-group').setAttribute('transform', 'rotate(-45, 100, 75)');
                document.getElementById('sim-biceps').setAttribute('d', 'M 60,70 Q 100,60 130,75');
                document.getElementById('sim-biceps').setAttribute('stroke-width', '12');
            } else if(action === 'muscle-relax') {
                document.getElementById('sim-arm-group').setAttribute('transform', 'rotate(0, 100, 75)');
                document.getElementById('sim-biceps').setAttribute('d', 'M 60,70 Q 100,70 130,75');
                document.getElementById('sim-biceps').setAttribute('stroke-width', '8');
            }
        };

        function runMiniSim(id, type) {
            const container = document.getElementById(`sim-container-${id}`);
            container.innerHTML = ''; 
            
            let content = `<div class="relative w-full h-full flex-1 bg-slate-800/50 flex items-center justify-center"><svg id="sim-svg" viewBox="0 0 200 150" class="w-full h-full">`;
            let controls = '';

            if (type === 'chew') {
                content += `<text x="10" y="20" class="sim-label">ì…</text><path d="M 50,40 Q 100,10 150,40" fill="#fca5a5" stroke="#fff" stroke-width="2" /><g id="sim-jaw"><path d="M 55,60 Q 100,90 145,60" fill="#fca5a5" stroke="#fff" stroke-width="2" /></g><g id="sim-food"><circle cx="100" cy="50" r="10" fill="#ef4444" /></g></svg></div>`;
                controls = `<button onclick="simAction('chew')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded m-2">ì”¹ê¸°</button>`;
            } else if (type === 'churn') {
                content += `<text x="10" y="20" class="sim-label">ìœ„</text><path id="sim-stomach-shape" d="M 60,40 Q 40,80 100,90 Q 160,80 140,40 Q 100,20 60,40" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" /><circle id="sim-stomach-food" cx="100" cy="60" r="8" fill="#ef4444" /></svg></div>`;
                controls = `<button onclick="simAction('churn')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded m-2">ì†Œí™”</button>`;
            } else if (type === 'bile-secretion') {
                content += `<text x="10" y="20" class="sim-label">ê°„</text><text x="80" y="30" class="sim-label">ì“¸ê°œ</text><path d="M 50,20 C 20,20 20,60 50,70 L 100,70 L 100,20 Z" fill="#581c87" opacity="0.8" /><circle cx="80" cy="60" r="10" fill="#16a34a" /><path d="M 80,70 L 80,100" stroke="#16a34a" stroke-width="4" /><circle cx="80" cy="60" r="5" fill="#a3e635" style="animation: drip 2s infinite;" /></svg></div>`;
            } else if (type === 'pancreas-juice') {
                content += `<text x="10" y="20" class="sim-label">ì´ì</text><path d="M 30,50 L 120,50 Q 140,50 120,80 L 30,80 Z" fill="#fcd34d" /><circle cx="80" cy="65" r="3" fill="#fff" style="animation: drip 1.5s infinite;" /><circle cx="60" cy="65" r="3" fill="#fff" style="animation: drip 1.5s infinite 0.5s;" /></svg></div>`;
            } else if (type === 'absorb') {
                 content += `<svg viewBox="0 0 100 100" class="w-full h-full"><path d="M 10,50 Q 30,30 50,50 Q 70,70 90,50" fill="none" stroke="#d97706" stroke-width="8" /><circle cx="50" cy="50" r="3" fill="#fbbf24"><animate attributeName="r" values="3; 8; 3" dur="1s" repeatCount="indefinite" /><animate attributeName="opacity" values="1; 0; 1" dur="1s" repeatCount="indefinite" /></circle><text x="35" y="80" font-size="10" fill="#fbbf24">ì˜ì–‘ì†Œ í¡ìˆ˜</text></svg></div>`;
            } else if (type === 'absorb-water') {
                content += `<text x="10" y="20" class="sim-label">í°ì°½ì</text><path d="M 20,50 L 120,50" stroke="#a16207" stroke-width="20" stroke-linecap="round" /><circle cx="50" cy="50" r="5" fill="#3b82f6"><animate attributeName="cy" from="50" to="80" dur="2s" repeatCount="indefinite" /><animate attributeName="opacity" from="1" to="0" dur="2s" repeatCount="indefinite" /></circle></svg></div>`;
            } else if (type === 'airflow') {
                content += `<text x="10" y="20" class="sim-label">ê¸°ê´€ì§€</text><path d="M 70,20 L 70,60 L 40,90 M 70,60 L 100,90" stroke="#cbd5e1" stroke-width="8" /><circle cx="70" cy="20" r="3" fill="#3b82f6"><animateMotion path="M 0,0 L 0,40 L -30,70" dur="2s" repeatCount="indefinite" /></circle><circle cx="70" cy="20" r="3" fill="#3b82f6"><animateMotion path="M 0,0 L 0,40 L 30,70" dur="2s" repeatCount="indefinite" begin="1s" /></circle></svg></div>`;
            } else if (type === 'flow-fast') {
                content += `<text x="10" y="20" class="sim-label">ë™ë§¥</text><rect x="20" y="40" width="100" height="20" fill="#fca5a5" stroke="#ef4444" stroke-width="3" /><circle cx="30" cy="50" r="4" fill="#ef4444"><animate attributeName="cx" from="30" to="110" dur="0.5s" repeatCount="indefinite" /></circle></svg></div>`;
            } else if (type === 'flow-slow') {
                content += `<text x="10" y="20" class="sim-label">ì •ë§¥ (íŒë§‰)</text><rect x="20" y="40" width="100" height="20" fill="#93c5fd" stroke="#3b82f6" stroke-width="2" /><path d="M 60,40 L 70,50 L 60,60" stroke="white" stroke-width="2" fill="none" /><circle cx="30" cy="50" r="4" fill="#1d4ed8"><animate attributeName="cx" from="30" to="110" dur="2s" repeatCount="indefinite" /></circle></svg></div>`;
            } else if (type === 'beat') {
                content += `<text x="10" y="20" class="sim-label">ì‹¬ì¥</text><path d="M 50,30 C 40,10 10,10 10,40 C 10,70 50,90 50,90 C 50,90 90,70 90,40 C 90,10 60,10 50,30" fill="#ef4444" style="animation: sim-beat 0.8s infinite;" /></svg></div>`;
            } else if (type === 'breathe') {
                content += `<text x="10" y="20" class="sim-label">í</text><path d="M 30,20 C 10,20 10,70 30,90 C 30,90 50,70 50,20" fill="#fca5a5" style="animation: sim-breathe 2s infinite alternate; transform-origin: center;" /><path d="M 70,20 C 90,20 90,70 70,90 C 70,90 50,70 50,20" fill="#fca5a5" style="animation: sim-breathe 2s infinite alternate; transform-origin: center;" /></svg></div>`;
            } else if (type === 'move-updown') {
                content += `<text x="10" y="20" class="sim-label">ê°€ë¡œë§‰</text><path d="M 10,50 Q 50,20 90,50" fill="none" stroke="#d97706" stroke-width="5" stroke-linecap="round"><animate attributeName="d" values="M 10,50 Q 50,20 90,50; M 10,50 Q 50,80 90,50; M 10,50 Q 50,20 90,50" dur="2s" repeatCount="indefinite" /></path></svg></div>`;
            } else if (type === 'transmit') {
                content += `<text x="10" y="20" class="sim-label">ê°ê°</text><text x="80" y="20" class="sim-label">ì‹ ê²½</text><text x="160" y="20" class="sim-label">ë‡Œ</text><circle cx="30" cy="75" r="10" fill="#fca5a5" /><path id="sim-brain" d="M 160,60 C 150,60 150,90 180,90 C 200,90 200,60 190,60" fill="#475569" /><line x1="40" y1="75" x2="160" y2="75" stroke="#cbd5e1" stroke-width="4" /><circle id="sim-nerve-signal" cx="40" cy="75" r="4" fill="#fbbf24" opacity="0" style="offset-path: path('M 40,75 L 160,75');" /></svg></div>`;
                controls = `<button onclick="simAction('stimulate')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded m-2">ìê·¹ ì£¼ê¸°</button>`;
            } else if (type === 'contract') {
                content += `<text x="10" y="20" class="sim-label">ë¼ˆ</text><text x="10" y="40" fill="#f87171" font-size="10" font-weight="bold">ê·¼ìœ¡</text><line x1="50" y1="75" x2="100" y2="75" stroke="#cbd5e1" stroke-width="10" stroke-linecap="round"/><g id="sim-arm-group" style="transition: transform 0.5s; transform-origin: 100px 75px;"><line x1="100" y1="75" x2="160" y2="75" stroke="#cbd5e1" stroke-width="8" stroke-linecap="round"/><circle cx="165" cy="75" r="5" fill="#cbd5e1"/></g><path id="sim-biceps" d="M 60,70 Q 100,70 130,75" fill="none" stroke="#fca5a5" stroke-width="8" stroke-linecap="round" style="transition: all 0.5s;" /></svg></div>`;
                controls = `<div class="flex gap-2 m-2"><button onclick="simAction('muscle-contract')" class="bg-red-600 hover:bg-red-500 text-white text-xs px-3 py-1 rounded">ìˆ˜ì¶•</button><button onclick="simAction('muscle-relax')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">ì´ì™„</button></div>`;
            } else if (type === 'bone-support') {
                content += `<text x="10" y="20" class="sim-label">ë¼ˆ (ì§€ì§€)</text><line x1="50" y1="20" x2="50" y2="120" stroke="#cbd5e1" stroke-width="15" stroke-linecap="round" /><line x1="20" y1="120" x2="80" y2="120" stroke="#cbd5e1" stroke-width="15" stroke-linecap="round" /></svg></div>`;
            }

            container.innerHTML = content + (controls ? `<div class="bg-slate-800 w-full flex justify-center border-t border-slate-700">${controls}</div>` : '');
        }

        // --- Game Functions ---
        function renderTools() {
            els.toolbox.innerHTML = currentCase.tools.map(tool => `
                <button type="button" id="tool-${tool.id}" onclick="selectTool('${tool.id}')" class="tool-btn flex flex-col items-center justify-center bg-slate-700 border border-slate-600 rounded-xl w-20 h-20 active:scale-95 group relative">
                    <div class="mb-1 text-slate-300 group-hover:text-blue-400 transition-colors">
                        <i data-lucide="${TOOL_ICONS[tool.id] || 'circle'}" class="w-8 h-8"></i>
                    </div>
                    <span class="text-[10px] text-slate-400 font-bold group-hover:text-white text-center leading-tight">${tool.name}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }
        function selectTool(toolId) {
            if (selectedTool) document.getElementById(`tool-${selectedTool}`).classList.remove('selected');
            if (selectedTool === toolId) { selectedTool = null; document.body.style.cursor = 'default'; return; }
            selectedTool = toolId; document.getElementById(`tool-${toolId}`).classList.add('selected'); document.body.style.cursor = 'crosshair';
            const tool = currentCase.tools.find(t => t.id === toolId); showMessage(`ğŸ›  ë„êµ¬ ì„ íƒ: ${tool.name} - ${tool.desc}`, "text-blue-300 font-bold");
        }
        function nextStep() {
            if (currentStepIndex >= currentCase.steps.length) { finishGame(true); return; }
            const step = currentCase.steps[currentStepIndex]; showMessage(`[ë‹¨ê³„ ${currentStepIndex + 1}/${currentCase.steps.length}] ${step.msg}`); els.currentObjective.innerText = step.hint;
        }
        function handleInteraction(targetId) {
            const step = currentCase.steps[currentStepIndex];
            let isCorrect = false;

            // Alias mapping to fix bug where stomach parts weren't recognized as stomach
            let checkId = targetId;
            if (step.target === 'stomach' && (targetId === 'stomach-inner' || targetId === 'food-lump')) checkId = 'stomach';

            if (step.action === "click_organ") {
                if (checkId === step.target && !selectedTool) isCorrect = true;
                else if (selectedTool) { failAction("ë„êµ¬ë¥¼ ë‚´ë ¤ë†“ê³  ì¥ê¸°ë¥¼ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”."); return; }
            } else if (step.action === "use_tool") {
                if (checkId === step.target && selectedTool === step.tool) isCorrect = true;
                else if (!selectedTool) { failAction("ë„êµ¬ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤."); return; }
                else if (selectedTool !== step.tool) { failAction("ì˜ëª»ëœ ë„êµ¬ì…ë‹ˆë‹¤!"); return; }
            }
            if (isCorrect) successAction(targetId);
            else if (targetId !== 'body-bg' && !targetId.includes('bg')) failAction("ì§€ê¸ˆ ì¹˜ë£Œí•´ì•¼ í•  ë¶€ìœ„ê°€ ì•„ë‹™ë‹ˆë‹¤.");
        }
        function successAction(targetId) {
            const step = currentCase.steps[currentStepIndex]; updateVisuals(targetId);
            const feedback = step.postMsg ? `âœ… ${step.postMsg}` : "âœ… ì„±ê³µ! ê¸°ëŠ¥ì´ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.";
            showMessage(feedback, "text-green-400"); currentStepIndex++;
            if(selectedTool) { document.getElementById(`tool-${selectedTool}`).classList.remove('selected'); selectedTool = null; document.body.style.cursor = 'default'; }
            nextStep();
        }
        function failAction(msg) {
            mistakes++; patientHealth -= 15; showMessage(`âš  ê²½ê³ : ${msg}`, "text-red-400 font-bold"); updateStatus();
            if (patientHealth <= 0) finishGame(false);
        }
        function finishGame(isSuccess) {
            if (isSuccess) { els.successReason.innerText = currentCase.successMsg; setTimeout(() => els.happyEndingScreen.classList.remove('hidden'), 1000); }
            else { setTimeout(() => els.badEndingScreen.classList.remove('hidden'), 500); }
        }
        function showMessage(text, className="text-slate-200") {
            const p = document.createElement('p'); p.className = `mb-3 fade-in ${className}`; p.innerText = text;
            els.dialogBox.appendChild(p); els.dialogBox.scrollTop = els.dialogBox.scrollHeight;
        }
        function updateStatus() {
            els.bpmDisplay.innerText = patientHealth > 0 ? (80 - mistakes * 15) : 0;
            if (patientHealth <= 0) { els.patientStatusText.innerText = "DEAD"; els.ecgLine.classList.add('flat'); }
            else if (patientHealth < 50) { els.patientStatusText.innerText = "CRITICAL"; els.patientStatusText.className = "text-red-500 font-bold text-sm blink"; els.ecgLine.classList.add('danger'); }
            else { els.patientStatusText.innerText = "STABLE"; els.patientStatusText.className = "text-green-500 font-bold text-sm"; els.ecgLine.classList.remove('danger', 'flat'); }
        }
        function renderSurgeryStage(caseId) {
            const bodyPath = `<g id="body-bg" onclick="handleInteraction('body-bg')"><path d="M 150,20 Q 120,20 120,60 Q 120,80 135,90 L 135,100 L 90,110 L 80,250 L 100,250 Q 100,350 90,400 L 100,530 L 200,530 L 210,400 Q 200,350 200,250 L 220,250 L 210,110 L 165,100 L 165,90 Q 180,80 180,60 Q 180,20 150,20 Z" fill="#334155" stroke="#475569" stroke-width="2" class="organ" /></g>`;
            let organs = '';
            // Backgrounds
            if (caseId !== 'digestive') organs += `<path d="M 155,250 C 175,240 190,260 180,290 C 160,300 150,280 155,250" fill="#b45309" opacity="0.2" />`;
            if (caseId !== 'respiratory') organs += `<path d="M 160,130 C 160,110 190,110 200,130 C 215,160 215,220 200,240 C 170,250 160,230 160,130" fill="#7f1d1d" opacity="0.2" /><path d="M 140,130 C 140,110 110,110 100,130 C 85,160 85,220 100,240 C 130,250 140,230 140,130" fill="#7f1d1d" opacity="0.2" />`;
            if (caseId !== 'sensory') organs += `<path d="M 130,35 C 120,35 120,70 150,70 C 180,70 180,35 170,35 Q 150,25 130,35" fill="#e2e8f0" opacity="0.2" />`;
            
            // Interactive Layers with HIT AREAS
            if (caseId === 'digestive') {
                organs += `
                    <!-- Head -->
                    <circle id="head" onclick="handleInteraction('head')" cx="150" cy="70" r="20" fill="transparent" stroke="#fca5a5" stroke-dasharray="4" class="organ hit-area"/>
                    
                    <!-- Esophagus -->
                    <path d="M 150,90 L 150,240" class="hit-area" onclick="handleInteraction('esophagus')" />
                    <path id="esophagus" onclick="handleInteraction('esophagus')" d="M 150,90 L 150,240" stroke="#fcd34d" stroke-width="12" class="organ" stroke-opacity="0.5"/>
                    
                    <!-- Stomach -->
                    <path d="M 155,250 C 175,240 190,260 180,300 C 160,310 145,280 155,250" class="hit-area" style="stroke-width:60px;" onclick="handleInteraction('stomach')" />
                    <circle id="stomach-inner" onclick="event.stopPropagation(); handleInteraction('stomach-inner')" cx="165" cy="280" r="20" fill="transparent" class="organ" />
                    <path id="stomach" onclick="handleInteraction('stomach')" d="M 155,250 C 175,240 190,260 180,300 C 160,310 145,280 155,250" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" class="organ"/>
                    
                    <!-- Food Lump (Top Layer) -->
                    <g id="food-lump" class="hidden organ" onclick="event.stopPropagation(); handleInteraction('food-lump')">
                        <circle cx="165" cy="275" r="15" fill="#ef4444" class="hit-area-fill" style="opacity:0; stroke-width:40px; stroke:white;" /> 
                        <circle cx="165" cy="275" r="12" fill="#ef4444" />
                        <circle cx="170" cy="285" r="8" fill="#ef4444" />
                    </g>
                    
                    <!-- Small Intestine (Yellow/Orange, Winding) -->
                    <path d="M 150,320 Q 180,310 170,340 T 150,360 T 130,340 T 150,320" class="hit-area" onclick="handleInteraction('small-intestine')" />
                    <path id="small-intestine" onclick="handleInteraction('small-intestine')" d="M 150,320 Q 180,310 170,340 T 150,360 T 130,340 T 150,320" fill="none" stroke="#d97706" stroke-width="12" stroke-linecap="round" class="organ"/>
                    
                    <!-- Large Intestine (Brown, Surrounding) -->
                    <path d="M 120,300 L 120,380 L 180,380 L 180,300" class="hit-area" onclick="handleInteraction('large-intestine')" />
                    <path id="large-intestine" onclick="handleInteraction('large-intestine')" d="M 120,300 L 120,380 L 180,380 L 180,300" fill="none" stroke="#a16207" stroke-width="18" stroke-linecap="round" stroke-linejoin="round" class="organ"/>
                `;
            } else if (caseId === 'respiratory') {
                organs += `
                    <circle id="head" onclick="handleInteraction('head')" cx="150" cy="75" r="15" fill="transparent" stroke="#fca5a5" stroke-width="2" stroke-dasharray="4" class="organ hit-area"/>
                    
                    <path d="M 150,90 L 150,130 M 150,130 L 130,160 M 150,130 L 170,160" class="hit-area" onclick="handleInteraction('bronchi')" />
                    <path id="bronchi" onclick="handleInteraction('bronchi')" d="M 150,90 L 150,130 M 150,130 L 130,160 M 150,130 L 170,160" stroke="#cbd5e1" stroke-width="8" class="organ"/>
                    
                    <g id="lungs" onclick="handleInteraction('lungs')" class="organ" style="transition: transform 1s">
                        <path d="M 145,140 C 100,140 90,240 145,240 Z" fill="#fca5a5" stroke="#e11d48" opacity="0.9" />
                        <path d="M 155,140 C 200,140 210,240 155,240 Z" fill="#fca5a5" stroke="#e11d48" opacity="0.9" />
                    </g>
                    
                    <path d="M 90,240 Q 150,200 210,240" class="hit-area" onclick="handleInteraction('diaphragm')" />
                    <path id="diaphragm" onclick="handleInteraction('diaphragm')" d="M 90,240 Q 150,200 210,240" fill="none" stroke="#d97706" stroke-width="8" stroke-linecap="round" class="organ hit-area" />
                `;
            } else if (caseId === 'circulatory') {
                organs += `
                    <g id="heart" onclick="handleInteraction('heart')" class="organ hit-area" transform="translate(150, 180)"><path d="M 0,-15 C -20,-40 -50,-10 -5,35 C 40,-10 20,-40 0,-15" fill="#991b1b" stroke="#ef4444" stroke-width="2" transform="scale(1.5)" /></g>
                    
                    <path d="M 150,165 C 150,140 180,140 180,190" class="hit-area" onclick="handleInteraction('aorta')" />
                    <path id="aorta" onclick="handleInteraction('aorta')" d="M 150,165 C 150,140 180,140 180,190" stroke="#ef4444" stroke-width="6" stroke-dasharray="4,2" fill="none" class="organ" />
                    
                    <path d="M 120,165 C 120,190 150,300 120,350" class="hit-area" onclick="handleInteraction('veins')" />
                    <path id="veins" onclick="handleInteraction('veins')" d="M 120,165 C 120,190 150,300 120,350" stroke="#3b82f6" stroke-width="6" fill="none" class="organ" />
                    
                    <circle id="blood-flow" r="3" fill="#fff" class="hidden"><animateMotion dur="1s" repeatCount="indefinite" path="M 150,165 C 150,140 180,140 180,190" /></circle>
                `;
            } else if (caseId === 'sensory') {
                organs += `
                    <path id="brain" onclick="handleInteraction('brain')" d="M 130,35 C 120,35 120,70 150,70 C 180,70 180,35 170,35 Q 150,25 130,35" fill="#fce7f3" stroke="#db2777" class="organ hit-area"/>
                    <g id="eye-left" onclick="handleInteraction('eye-left')" class="organ hit-area"><circle cx="135" cy="60" r="4" fill="#fff" stroke="#cbd5e1"/><circle cx="135" cy="60" r="1.5" fill="#000"/></g>
                    <rect id="hand-area" onclick="handleInteraction('hand-area')" x="210" y="250" width="30" height="30" fill="transparent" stroke="#a855f7" stroke-dasharray="4" class="organ hit-area" />
                `;
            } else if (caseId === 'muscular') {
                organs += `
                    <rect id="arm-area" onclick="handleInteraction('arm-area')" x="200" y="120" width="50" height="100" fill="transparent" stroke="#a855f7" stroke-dasharray="4" class="organ hit-area" />
                    <g id="arm-detail" class="hidden" transform="translate(180, 100) scale(0.9)">
                        <path d="M 30,20 L 60,100" stroke="#94a3b8" stroke-width="15" stroke-linecap="round"/>
                        <circle cx="60" cy="100" r="10" fill="#e2e8f0"/>
                        <g onclick="handleInteraction('broken-bone')" class="organ hit-area" style="transform-origin: 60px 100px; transform: rotate(15deg);"><path d="M 60,100 L 80,180" stroke="transparent" stroke-width="40" /></g>
                        <g id="broken-bone" onclick="handleInteraction('broken-bone')" class="organ" style="transform-origin: 60px 100px; transform: rotate(15deg);"><path d="M 60,100 L 80,180" stroke="#94a3b8" stroke-width="12" stroke-linecap="round"/></g>
                        <path onclick="handleInteraction('biceps')" d="M 40,40 Q 20,80 50,120" fill="none" stroke="transparent" stroke-width="35" class="hit-area" />
                        <path id="biceps" onclick="handleInteraction('biceps')" d="M 40,40 Q 20,80 50,120" fill="none" stroke="#fca5a5" stroke-width="12" stroke-linecap="round" stroke-dasharray="5,2" class="organ" />
                    </g>
                `;
            }
            els.surgeryStage.innerHTML = `<svg viewBox="0 0 300 550" class="h-full w-auto drop-shadow-2xl">${bodyPath}${organs}</svg>`;
        }

        function updateVisuals(targetId) {
            const el = document.getElementById(targetId);
            if (!el && targetId !== 'body-bg') return;
            if (targetId === 'stomach') {
                if (currentStepIndex === 4) {
                    el.setAttribute('stroke', '#ef4444'); el.setAttribute('stroke-dasharray', '5,2');
                    document.getElementById('food-lump').classList.remove('hidden');
                } else if (currentStepIndex === 7 && selectedTool === 'suture') {
                    el.setAttribute('stroke', '#fcd34d'); el.removeAttribute('stroke-dasharray');
                }
            } else if (targetId === 'food-lump') { el.classList.add('hidden'); }
            else if (targetId === 'stomach-inner') { el.setAttribute('fill', 'rgba(134, 239, 172, 0.5)'); }
            else if (targetId === 'small-intestine') { el.setAttribute('stroke', '#fcd34d'); }
            else if (targetId === 'large-intestine') { el.setAttribute('stroke', '#854d0e'); }
            else if (targetId === 'diaphragm') {
                if (currentStepIndex === 4) el.setAttribute('stroke', '#fcd34d');
                else if (currentStepIndex === 5) {
                    el.setAttribute('d', "M 90,260 Q 150,280 210,260");
                    document.getElementById('lungs').setAttribute('transform', 'scale(1.1) translate(-15, -5)');
                }
            } else if (targetId === 'head') {
                if(currentCase.tools.find(t=>t.id==='oxygen') && selectedTool==='oxygen') {
                    el.setAttribute('fill', 'rgba(125, 211, 252, 0.3)'); el.setAttribute('stroke', '#38bdf8');
                }
            } else if (targetId === 'heart') { if(selectedTool === 'defib') el.classList.add('pulse-target'); }
            else if (targetId === 'aorta') { el.removeAttribute('stroke-dasharray'); document.getElementById('blood-flow').classList.remove('hidden'); }
            else if (targetId === 'veins') { el.setAttribute('stroke', '#2563eb'); }
            else if (targetId === 'body-bg') {
                 const svg = document.querySelector('#surgery-stage svg');
                 const scanLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                 scanLine.setAttribute("x1", "0"); scanLine.setAttribute("y1", "0"); scanLine.setAttribute("x2", "300"); scanLine.setAttribute("y2", "0");
                 scanLine.setAttribute("stroke", "#38bdf8"); scanLine.setAttribute("stroke-width", "5"); scanLine.setAttribute("opacity", "0.8");
                 const anim = document.createElementNS("http://www.w3.org/2000/svg", "animate");
                 anim.setAttribute("attributeName", "y1"); anim.setAttribute("from", "0"); anim.setAttribute("to", "550"); anim.setAttribute("dur", "1.5s"); anim.setAttribute("fill", "freeze");
                 const anim2 = document.createElementNS("http://www.w3.org/2000/svg", "animate");
                 anim2.setAttribute("attributeName", "y2"); anim2.setAttribute("from", "0"); anim2.setAttribute("to", "550"); anim2.setAttribute("dur", "1.5s"); anim2.setAttribute("fill", "freeze");
                 scanLine.appendChild(anim); scanLine.appendChild(anim2); svg.appendChild(scanLine);
            } else if (targetId === 'eye-left') { el.querySelector('circle:last-child').setAttribute('fill', '#000'); }
            else if (targetId === 'brain') { el.setAttribute('fill', '#f472b6'); }
            else if (targetId === 'hand-area') { el.setAttribute('fill', '#fca5a5'); }
            else if (targetId === 'broken-bone') {
                if (currentStepIndex === 1) el.setAttribute('d', "M 60,100 L 60,180");
                else if (currentStepIndex === 2) el.setAttribute('stroke', '#94a3b8');
            } else if (targetId === 'biceps') {
                if (currentStepIndex === 3) el.removeAttribute('stroke-dasharray');
                else if (currentStepIndex === 4) el.setAttribute('stroke', '#f87171');
            } else if (targetId === 'arm-area') {
                el.classList.add('hidden'); document.getElementById('arm-detail').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>